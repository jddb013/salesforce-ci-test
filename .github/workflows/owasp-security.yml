name: OWASP Security Scan

on:
  pull_request:
    branches:
      - main  # Se ejecuta en cada PR hacia main
  schedule:
    - cron: '0 0 * * 1'  # Se ejecuta cada lunes a medianoche UTC

jobs:
  security-check:
    name: OWASP Security Analysis
    runs-on: ubuntu-latest  # Usa un contenedor Linux

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Instala Node.js para analizar dependencias de LWC
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      # Instala dependencias de manera segura
      - name: Install dependencies
        run: npm install --legacy-peer-deps

      # Instala OWASP Dependency-Check
      - name: Run OWASP Dependency-Check
        run: |
          npm install -g dependency-check
          dependency-check --scan package.json --out owasp-report.html || true

      # Instala ESLint y sus plugins de seguridad correctamente
      - name: Install ESLint and plugins
        run: |
          npm install eslint@9 eslint-plugin-lwc eslint-plugin-security --save-dev

      # Ejecuta ESLint con las reglas correctas
      - name: Run ESLint Security Check
        run: |
          npx eslint force-app/main/default/lwc --ext .js --plugin security --rule 'security/detect-object-injection: error'

      # Guarda los reportes como artefactos en GitHub Actions
      - name: Upload OWASP Report
        uses: actions/upload-artifact@v4
        with:
          name: owasp-security-report
          path: owasp-report.html
